name: âš™ï¸ Deploy API to VPS (Auto + Telegram)

on:
  push:
    branches: [ "main" ]   # Tá»± Ä‘á»™ng cháº¡y khi push code lÃªn nhÃ¡nh main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------
    # 1ï¸âƒ£ Láº¥y code má»›i nháº¥t tá»« repo GitHub
    # ------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ------------------------------------------
    # 2ï¸âƒ£ Triá»ƒn khai API lÃªn VPS qua SSH
    # ------------------------------------------
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script_stop: true
        script: |
          set -e

          echo "[1/7] Äi tá»›i thÆ° má»¥c API trÃªn VPS"
          cd /var/www/vattukc-api

          echo "[2/7] Cáº­p nháº­t code má»›i nháº¥t tá»« GitHub"
          git fetch --all
          git reset --hard origin/main
          git pull --rebase origin main

          echo "[3/7] CÃ i dependencies"
          npm ci || npm install --force

          echo "[4/7] Build (náº¿u cÃ³)"
          npm run build || echo "KhÃ´ng cÃ³ script build, bá» qua"

          echo "[5/7] Restart PM2 process"
          pm2 describe vattukc-api >/dev/null 2>&1 \
            && pm2 restart vattukc-api \
            || pm2 start npm --name "vattukc-api" -- run start

          echo "[6/7] LÆ°u danh sÃ¡ch process"
          pm2 save

          echo "âœ… HoÃ n táº¥t deploy API!"

          # ------------------------------------------
          # 7ï¸âƒ£ Gá»­i thÃ´ng bÃ¡o vá» Telegram
          # ------------------------------------------
          echo "[7/7] Gá»­i thÃ´ng bÃ¡o Telegram"
          MESSAGE="âœ… Triá»ƒn khai API thÃ nh cÃ´ng trÃªn VPS!%0AğŸ“¦ Repo: vattukc-api%0AğŸš€ Branch: main%0AğŸ•’ $(date +'%Y-%m-%d %H:%M:%S')"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}"
