name: âš™ï¸ Deploy API to VPS

on:
  push:
    branches: [ "main" ]   # Tá»± Ä‘á»™ng cháº¡y khi push code lÃªn nhÃ¡nh main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script_stop: true
        script: |
          set -e
          echo "[1/6] Äi tá»›i thÆ° má»¥c API trÃªn VPS"
          cd /var/www/vattukc-api

          echo "[2/6] Cáº­p nháº­t code má»›i nháº¥t"
          git fetch --all
          git reset --hard origin/main
          git pull --rebase origin main

          echo "[3/6] CÃ i dependencies"
          npm ci || npm install --force

          echo "[4/6] Build (náº¿u cÃ³)"
          npm run build || echo "KhÃ´ng cÃ³ script build, bá» qua"

          echo "[5/6] Restart PM2"
          pm2 describe vattukc-api >/dev/null 2>&1 \
            && pm2 restart vattukc-api \
            || pm2 start npm --name "vattukc-api" -- run start

          echo "[6/6] LÆ°u process list"
          pm2 save

          echo "âœ… HoÃ n táº¥t deploy API!"
                    echo "[7/7] Gá»­i thÃ´ng bÃ¡o Telegram"
          MESSAGE="âœ… Triá»ƒn khai API thÃ nh cÃ´ng trÃªn VPS!%0AðŸ“¦ Repo: vattukc-api%0AðŸš€ Branch: main%0AðŸ•’ $(date +'%Y-%m-%d %H:%M:%S')"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}"

